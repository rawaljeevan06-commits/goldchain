<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | GoldChain</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>

  <div class="dash-wrap">
    <header class="dash-top">
      <div>
        <h1 class="dash-title">GoldChain Dashboard</h1>
        <p class="dash-sub">You are successfully logged in ✅</p>
        <p id="userEmail" class="dash-email"></p>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="logoutBtn" class="btn btn-logout" type="button">Logout</button>
        <button id="clearPlanBtn" class="btn btn-outline" type="button">Clear Plan</button>
        <button id="payNowBtn" class="btn btn-primary" type="button">Pay Now</button>
      </div>
    </header>

    <section class="dash-cards">
      <div class="card">
        <h3>Account</h3>
        <p class="muted">Status</p>
        <p class="big">Active ✅</p>
      </div>

      <div class="card">
        <h3>Payment Status</h3>
        <p class="muted" id="paymentStatusText">Checking…</p>
      </div>

      <div class="card">
        <h3>Plan</h3>
        <p class="muted">Current plan</p>
        <p class="big" id="dashPlanName">Not selected</p>
        <p class="muted" id="dashPlanInfo"></p>
      </div>

      <div class="card">
        <h3>Weekly Profit</h3>
        <p class="muted">Estimated</p>
        <p class="big" id="weeklyProfitValue">$0.00</p>
      </div>
    </section>

    <div class="dash-box">
      <h2>Profit Calculator</h2>
      <p class="muted">Enter amount to calculate weekly profit.</p>

      <div class="calc-row">
        <input type="number" id="dashAmount" placeholder="Enter amount in USD" />
        <button class="btn btn-primary" id="dashCalcBtn" type="button">Calculate</button>
      </div>

      <div id="dashCalcResult" class="calc-result" style="display:none;"></div>
    </div>
  </div>

  <script type="module">
    import { auth } from "./js/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    const ADMIN_UIDS = ["40B1eYKROIXFAZLpelBhjjFTDm72"];

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.replace("login.html");
    return;
  }

  if (ADMIN_UIDS.includes(user.uid)) {
    window.location.replace("admin.html");
    return;
  }

  // normal user continues here
});
onAuthStateChanged(auth, (user) => {
  if (user) {
    alert("Your UID is:\n" + user.uid);
    console.log("UID:", user.uid);
  }
});
    console.log("✅ Dashboard script running");

    // ----------------- ELEMENTS -----------------
    const payNowBtn = document.getElementById("payNowBtn");
    const clearBtn  = document.getElementById("clearPlanBtn");
    const calcBtn   = document.getElementById("dashCalcBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const statusEl  = document.getElementById("paymentStatusText");
    const emailEl   = document.getElementById("userEmail");

    const nameEl    = document.getElementById("dashPlanName");
    const infoEl    = document.getElementById("dashPlanInfo");
    const profitEl  = document.getElementById("weeklyProfitValue");
    const resultEl  = document.getElementById("dashCalcResult");

    // ----------------- SAFE STORAGE -----------------
    function getStorage(key) {
      try { return localStorage.getItem(key); } catch(e) { return null; }
    }
    function getSession(key) {
      try { return sessionStorage.getItem(key); } catch(e) { return null; }
    }

    // Percent rules (fallback)
    function percentByAmount(amount) {
      const a = Number(amount) || 0;
      if (a >= 5000) return 4;
      if (a >= 1000) return 3;
      if (a >= 700) return 2;
      if (a >= 350) return 1.5;
      return 0;
    }

    // ✅ Handles BOTH:
    // 1) JSON stored plan {name, amount, percent, withdraw}
    // 2) plain string "Basic - $350" or "Growth - $700"
    function loadPlanSafely() {
      const raw = getSession("selectedPlan") || getStorage("selectedPlan");
      if (!raw) return null;

      // Try JSON first
      try {
        const obj = JSON.parse(raw);
        if (obj && typeof obj === "object") {
          const amount = Number(obj.amount || 0);
          return {
            name: obj.name || "Selected Plan",
            amount,
            percent: Number(obj.percent || percentByAmount(amount)),
            withdraw: obj.withdraw || ""
          };
        }
      } catch(e) {}

      // Try parse string
      // Examples: "Basic - $350" / "Growth Plan - $700"
      const amtMatch = raw.match(/(\d{2,})/);
      const amount = amtMatch ? Number(amtMatch[1]) : 0;
      return {
        name: raw.replace(/\s+/g, " ").trim(),
        amount,
        percent: percentByAmount(amount),
        withdraw: ""
      };
    }

    function loadLocalPaymentProof() {
      const raw = getStorage("paymentProof");
      if (!raw) return null;
      try { return JSON.parse(raw); } catch(e) { return null; }
    }

    // ----------------- RENDER PLAN -----------------
    function renderPlan() {
      const plan = loadPlanSafely();

      if (!plan) {
        nameEl.textContent = "Not selected";
        infoEl.textContent = "";
        profitEl.textContent = "$0.00";
        return;
      }

      nameEl.textContent = plan.name || "Selected Plan";

      const withdrawText = plan.withdraw ? ` • ${plan.withdraw}` : "";
      infoEl.textContent = `$${plan.amount} • ${plan.percent}% weekly${withdrawText}`;
    }

    // ----------------- PAYMENT STATUS (Firestore first) -----------------
    function setStatus(text) {
      if (statusEl) statusEl.textContent = text;
    }

    async function renderPaymentStatusFromFirestore(user) {
      // default
      setStatus("Checking…");

      // 1) Try Firestore (global)
      try {
        const { db } = await import("./js/firebase.js");
        const {
          collection,
          query,
          where,
          orderBy,
          limit,
          getDocs
        } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");

        const q = query(
          collection(db, "payments"),
          where("uid", "==", user.uid),
          orderBy("createdAt", "desc"),
          limit(1)
        );

        const snap = await getDocs(q);

        if (!snap.empty) {
          const doc = snap.docs[0].data();
          const st = (doc.status || "").toLowerCase();

          if (st === "verified") {
            setStatus("✅ Payment Verified — Full access unlocked");
            return;
          }
          if (st === "pending") {
            setStatus("⏳ Payment Pending — Waiting for verification");
            return;
          }

          // Unknown status fallback
          setStatus(`ℹ️ Payment Status: ${doc.status || "Unknown"}`);
          return;
        }
      } catch (e) {
        console.log("Firestore payment status failed, fallback to local:", e);
      }

      // 2) Fallback: localStorage (same device)
      const proof = loadLocalPaymentProof();
      if (proof && proof.txid) {
        setStatus("⏳ Payment Pending — Waiting for verification");
      } else {
        setStatus("❌ No payment submitted");
      }
    }

    // ----------------- BUTTONS -----------------
    payNowBtn?.addEventListener("click", () => {
      const plan = loadPlanSafely();
      if (!plan) {
        alert("No plan selected. Please choose a plan first.");
        window.location.href = "plans.html";
        return;
      }
      window.location.href = "payment.html";
    });

    clearBtn?.addEventListener("click", () => {
      try { localStorage.removeItem("selectedPlan"); } catch(e) {}
      try { sessionStorage.removeItem("selectedPlan"); } catch(e) {}
      renderPlan();
      alert("Plan cleared");
    });

    calcBtn?.addEventListener("click", () => {
      const plan = loadPlanSafely();

      if (!plan) {
        resultEl.style.display = "block";
        resultEl.textContent = "Please select a plan first.";
        return;
      }

      const amount = Number(document.getElementById("dashAmount").value);
      if (!amount || amount <= 0) {
        resultEl.style.display = "block";
        resultEl.textContent = "Enter a valid amount.";
        return;
      }

      const profit = (amount * Number(plan.percent || 0)) / 100;
      resultEl.style.display = "block";
      resultEl.textContent = `Estimated weekly profit: $${profit.toFixed(2)}`;
      profitEl.textContent = `$${profit.toFixed(2)}`;
    });

    // ----------------- LOGOUT fallback (always works) -----------------
    logoutBtn?.addEventListener("click", () => {
      window.location.replace("login.html");
    });

    // ----------------- FIREBASE AUTH PROTECT -----------------
    (async () => {
      try {
        const { auth } = await import("./js/firebase.js");
        const { onAuthStateChanged, signOut } =
          await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");

        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            window.location.replace("login.html");
            return;
          }

          if (emailEl) emailEl.textContent = user.email || "";

          // ✅ Update payment status using Firestore (global)
          await renderPaymentStatusFromFirestore(user);
        });

        // Real signOut
        if (logoutBtn) {
          logoutBtn.onclick = async () => {
            try { await signOut(auth); } catch(e) {}
            window.location.replace("login.html");
          };
        }
      } catch (e) {
        console.log("Firebase import failed:", e);
        // If Firebase fails, we still show local payment status
        const proof = loadLocalPaymentProof();
        if (proof && proof.txid) setStatus("⏳ Payment Pending — Waiting for verification");
        else setStatus("❌ No payment submitted");
      }
    })();

    // ----------------- INITIAL RENDER -----------------
    renderPlan();
    // Payment status will be updated after auth loads
  </script>

</body>
</html>
