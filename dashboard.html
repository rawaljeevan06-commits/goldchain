<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | GoldChain</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

  <div class="topbar">GoldChain Dashboard — Secure Access</div>

  <header class="header">
    <div class="container header-in">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="GoldChain Logo">
        <span>GoldChain</span>
      </a>

      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="plans.html">Plans</a>
      </nav>

      <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="logoutBtn" class="btn btn-logout" type="button">Logout</button>
        <button id="clearPlanBtn" class="btn btn-outline" type="button">Clear Plan</button>
        <button id="payNowBtn" class="btn btn-primary" type="button">Pay Now</button>
        <button id="withdrawBtn" class="btn btn-primary" type="button">Withdrawal</button>
      </div>
    </div>
  </header>

  <section class="section">
    <div class="container">

      <div class="card">
        <h1>GoldChain Dashboard</h1>
        <p class="small">
          You are successfully logged in ✅
          <br>
          <strong id="emailEl">Checking…</strong>
        </p>
      </div>

      <div class="dash-cards" style="margin-top:14px;">
        <div class="card">
          <h3>Account</h3>
          <p class="muted">Status</p>
          <p class="big" id="accountStatus">Checking…</p>
        </div>

        <div class="card">
          <h3>Payment Status</h3>
          <p class="big" id="payStatus">Checking…</p>
        </div>

        <div class="card">
          <h3>Plan</h3>
          <p class="muted">Current plan</p>
          <p class="big" id="planEl">Not selected</p>
          <p class="small" id="planPctEl" style="opacity:.8;"></p>
        </div>

        <!-- OPTION 2: Weekly profit shown, but based on 16% MONTHLY -->
        <div class="card">
          <h3>Weekly Profit</h3>
          <p class="muted">Estimated (from monthly)</p>
          <p class="big" id="weeklyProfitEl">$0.00</p>
        </div>

        <div class="card">
          <h3>Available Balance</h3>
          <p class="muted">Earned - Approved Withdrawals</p>
          <p class="big" id="balanceEl">$0.00</p>
          <p class="small" id="balanceNote" style="opacity:.8;"></p>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <h2>Profit Calculator</h2>
        <p class="small">Enter amount to calculate weekly profit (16% monthly ÷ 4).</p>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;">
          <input id="amountInput" type="number" min="0" step="1" placeholder="Enter amount in USD"
                 style="padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0e0f12; color:#fff; width:240px;">
          <button id="calcBtn" class="btn btn-primary" type="button">Calculate</button>
        </div>

        <p class="small" id="resultEl" style="margin-top:10px; display:none;"></p>
      </div>

      <!-- ✅ ONLY ONE History section (no duplicates) -->
      <div class="card" style="margin-top:14px;">
        <h2>History</h2>
        <p class="small" id="historyMsg">Loading history…</p>

        <hr style="margin:18px 0; opacity:.25;">

        <h3>Payment History</h3>
        <div style="overflow:auto; margin-top:10px;">
          <table style="width:100%; border-collapse:collapse; min-width:900px;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid rgba(255,255,255,.15);">
                <th style="padding:10px;">Time</th>
                <th style="padding:10px;">Plan</th>
                <th style="padding:10px;">Amount</th>
                <th style="padding:10px;">Method</th>
                <th style="padding:10px;">TXID</th>
                <th style="padding:10px;">Status</th>
              </tr>
            </thead>
            <tbody id="payHistoryBody"></tbody>
          </table>
        </div>

        <hr style="margin:18px 0; opacity:.25;">

        <h3>Withdrawal History</h3>
        <div style="overflow:auto; margin-top:10px;">
          <table style="width:100%; border-collapse:collapse; min-width:900px;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid rgba(255,255,255,.15);">
                <th style="padding:10px;">Time</th>
                <th style="padding:10px;">Amount</th>
                <th style="padding:10px;">Wallet</th>
                <th style="padding:10px;">Status</th>
              </tr>
            </thead>
            <tbody id="wdHistoryBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, where, orderBy, limit, getDocs,
      doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ Admin UIDs (same list as admin.html)
    const ADMIN_UIDS = ["40B1eYKROIXFAZLpelBhjjFTDm72"];

    // UI
    const emailEl = document.getElementById("emailEl");
    const accountStatus = document.getElementById("accountStatus");
    const payStatus = document.getElementById("payStatus");
    const planEl = document.getElementById("planEl");
    const planPctEl = document.getElementById("planPctEl");
    const weeklyProfitEl = document.getElementById("weeklyProfitEl");
    const balanceEl = document.getElementById("balanceEl");
    const balanceNote = document.getElementById("balanceNote");

    const amountInput = document.getElementById("amountInput");
    const calcBtn = document.getElementById("calcBtn");
    const resultEl = document.getElementById("resultEl");

    const payHistoryBody = document.getElementById("payHistoryBody");
    const wdHistoryBody = document.getElementById("wdHistoryBody");
    const historyMsg = document.getElementById("historyMsg");

    const logoutBtn = document.getElementById("logoutBtn");
    const clearPlanBtn = document.getElementById("clearPlanBtn");
    const payNowBtn = document.getElementById("payNowBtn");
    const withdrawBtn = document.getElementById("withdrawBtn");

    // Helpers
    function esc(s) {
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function formatTime(ts) {
      try {
        if (!ts) return "-";
        if (typeof ts.toDate === "function") return ts.toDate().toLocaleString();
        return new Date(ts).toLocaleString();
      } catch { return "-"; }
    }

    function money(n) {
      const x = Number(n || 0);
      if (!Number.isFinite(x)) return "$0.00";
      return "$" + x.toFixed(2);
    }

    function loadSelectedPlanRaw() {
      let plan = "";
      try { plan = localStorage.getItem("selectedPlan") || ""; } catch(e){}
      if (!plan) {
        try { plan = sessionStorage.getItem("selectedPlan") || ""; } catch(e){}
      }
      return plan;
    }

    // ✅ Plan parsing (handles JSON or plain text)
    function parsePlan(raw) {
      if (!raw) return null;
      const s = String(raw).trim();
      if (s.startsWith("{") && s.endsWith("}")) {
        try {
          const obj = JSON.parse(s);
          return obj && typeof obj === "object" ? obj : null;
        } catch { return null; }
      }
      return { name: s };
    }

    function parseAmountFromText(txt) {
      const m = String(txt || "").match(/\$?\s*([0-9]+(\.[0-9]+)?)/);
      if (!m) return 0;
      return Number(m[1]) || 0;
    }

    // ✅ You wanted: 16% MONTHLY for all plans (>=350)
    function monthlyPercentByAmount(amount) {
      const a = Number(amount || 0);
      if (!Number.isFinite(a) || a < 350) return 0;
      return 16;
    }

    async function renderAccountAccess(user) {
      const rawPlan = loadSelectedPlanRaw();
      const planObj = parsePlan(rawPlan);

      const planName = planObj?.name || "Not selected";
      const planAmount = Number(planObj?.amount || parseAmountFromText(rawPlan) || 0);
      const monthlyPct = Number(planObj?.percent || monthlyPercentByAmount(planAmount) || 0);

      const withdrawText =
        planObj?.withdraw ||
        planObj?.withdrawDays ||
        planObj?.withdrawal ||
        "";

      planEl.textContent = planName;

      // Show monthly info in plan text
      planPctEl.textContent = monthlyPct
        ? `${monthlyPct}% monthly${withdrawText ? " • " + withdrawText : ""}`
        : "";

      // ✅ OPTION 2: Weekly profit from monthly (÷4)
      const monthlyProfit = monthlyPct ? (planAmount * monthlyPct) / 100 : 0;
      const weeklyProfit = monthlyProfit / 4;
      weeklyProfitEl.textContent = money(weeklyProfit);

      // Balance
      try {
        const uRef = doc(db, "users", user.uid);
        const uSnap = await getDoc(uRef);
        const bal = uSnap.exists() ? Number(uSnap.data()?.balance || 0) : 0;
        balanceEl.textContent = money(bal);
        balanceNote.textContent = bal > 0 ? "Withdrawal available." : "No earnings yet.";
      } catch (e) {
        console.warn("Balance load failed:", e);
        balanceEl.textContent = "$0.00";
        balanceNote.textContent = "Could not load balance.";
      }

      accountStatus.textContent = "Active ✅";
      payStatus.textContent = "Checking…";

      try {
        const qVerified = query(
          collection(db, "payments"),
          where("uid", "==", user.uid),
          where("status", "==", "verified"),
          orderBy("createdAt", "desc"),
          limit(1)
        );

        let snap;
        try { snap = await getDocs(qVerified); }
        catch {
          snap = await getDocs(query(
            collection(db, "payments"),
            where("uid", "==", user.uid),
            where("status", "==", "verified"),
            limit(1)
          ));
        }

        payStatus.textContent = snap.empty
          ? "⏳ Not verified — Please complete payment"
          : "✅ Payment Verified — Full access unlocked";
      } catch (e) {
        console.warn("Payment check failed:", e);
        payStatus.textContent = "⚠️ Could not check payment";
      }
    }

    async function loadHistoryForUser(user) {
      if (historyMsg) historyMsg.textContent = "Loading history…";

      // Payments
      try {
        if (payHistoryBody) payHistoryBody.innerHTML = "";

        const qPay = query(
          collection(db, "payments"),
          where("uid", "==", user.uid),
          orderBy("createdAt", "desc"),
          limit(20)
        );

        let snap;
        try { snap = await getDocs(qPay); }
        catch {
          snap = await getDocs(query(
            collection(db, "payments"),
            where("uid", "==", user.uid),
            limit(20)
          ));
        }

        if (snap.empty) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td style="padding:10px;" colspan="6">No payments yet.</td>`;
          payHistoryBody.appendChild(tr);
        } else {
          snap.forEach(d => {
            const p = d.data();
            const tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid rgba(255,255,255,.08)";
            tr.innerHTML = `
              <td style="padding:10px;">${esc(formatTime(p.createdAt))}</td>
              <td style="padding:10px;">${esc(p.planName || "-")}</td>
              <td style="padding:10px;">$${esc(p.amount ?? "-")}</td>
              <td style="padding:10px;">${esc(p.method || "-")}</td>
              <td style="padding:10px; max-width:260px; word-break:break-all;">${esc(p.txid || "-")}</td>
              <td style="padding:10px;">${esc(p.status || "-")}</td>
            `;
            payHistoryBody.appendChild(tr);
          });
        }
      } catch (e) {
        console.error("Payments history error:", e);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td style="padding:10px;" colspan="6">Failed to load payments history.</td>`;
        payHistoryBody?.appendChild(tr);
      }

      // Withdrawals
      try {
        if (wdHistoryBody) wdHistoryBody.innerHTML = "";

        const qWd = query(
          collection(db, "withdrawals"),
          where("uid", "==", user.uid),
          orderBy("createdAt", "desc"),
          limit(20)
        );

        let snap;
        try { snap = await getDocs(qWd); }
        catch {
          snap = await getDocs(query(
            collection(db, "withdrawals"),
            where("uid", "==", user.uid),
            limit(20)
          ));
        }

        if (snap.empty) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td style="padding:10px;" colspan="4">No withdrawals yet.</td>`;
          wdHistoryBody.appendChild(tr);
        } else {
          snap.forEach(d => {
            const w = d.data();
            const tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid rgba(255,255,255,.08)";
            tr.innerHTML = `
              <td style="padding:10px;">${esc(formatTime(w.createdAt))}</td>
              <td style="padding:10px;">$${esc(w.amount ?? "-")}</td>
              <td style="padding:10px; max-width:320px; word-break:break-all;">${esc(w.wallet || w.walletAddress || "-")}</td>
              <td style="padding:10px;">${esc(w.status || "-")}</td>
            `;
            wdHistoryBody.appendChild(tr);
          });
        }
      } catch (e) {
        console.error("Withdrawals history error:", e);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td style="padding:10px;" colspan="4">Failed to load withdrawals history.</td>`;
        wdHistoryBody?.appendChild(tr);
      }

      if (historyMsg) historyMsg.textContent = "✅ History loaded.";
    }

    // Calculator: weekly from monthly ÷ 4
    calcBtn?.addEventListener("click", () => {
      const amount = Number(amountInput?.value || 0);
      if (!amount || amount <= 0) {
        resultEl.style.display = "block";
        resultEl.textContent = "Enter a valid amount.";
        return;
      }
      const monthlyPct = monthlyPercentByAmount(amount);
      if (!monthlyPct) {
        resultEl.style.display = "block";
        resultEl.textContent = "Amount is below minimum plan ($350).";
        return;
      }

      const monthlyProfit = (amount * monthlyPct) / 100;
      const weeklyProfit = monthlyProfit / 4;

      resultEl.style.display = "block";
      resultEl.textContent =
        `Estimated weekly profit: $${weeklyProfit.toFixed(2)} (based on ${monthlyPct}% monthly)`;
    });

    // Buttons
    logoutBtn?.addEventListener("click", async () => {
      try { await signOut(auth); } catch(e){}
      window.location.replace("login.html");
    });

    clearPlanBtn?.addEventListener("click", () => {
      try { localStorage.removeItem("selectedPlan"); } catch(e){}
      try { sessionStorage.removeItem("selectedPlan"); } catch(e){}
      planEl.textContent = "Not selected";
      planPctEl.textContent = "";
      weeklyProfitEl.textContent = "$0.00";
      alert("Plan cleared.");
    });

    payNowBtn?.addEventListener("click", () => {
      const plan = loadSelectedPlanRaw();
      if (!plan) {
        alert("No plan selected. Please choose a plan first.");
        window.location.href = "plans.html";
        return;
      }
      window.location.href = "payment.html";
    });

    withdrawBtn?.addEventListener("click", () => {
      window.location.href = "withdrawal.html";
    });

    // Only ONE auth listener
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.replace("login.html");
        return;
      }

      // admin redirect
      if (ADMIN_UIDS.includes(user.uid)) {
        window.location.replace("admin.html");
        return;
      }

      if (emailEl) emailEl.textContent = user.email || user.uid;

      await renderAccountAccess(user);
      await loadHistoryForUser(user);
    });
  </script>

</body>
</html>
