<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin | Payments</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

  <div class="topbar">Admin Panel — Payment Verification</div>

  <header class="header">
    <div class="container header-in">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="GoldChain Logo">
        <span>GoldChain</span>
      </a>

      <nav class="nav">
        <a href="dashboard.html">Dashboard</a>
      </nav>

      <div class="actions">
        <button id="refreshBtn" class="btn btn-outline" type="button">Refresh</button>
        <button id="logoutBtn" class="btn btn-logout" type="button">Logout</button>
      </div>
    </div>
  </header>

  <section class="section">
    <div class="container">
      <div class="card">
        <h2>Pending Payments</h2>
        <p class="small" id="adminInfo">Checking admin access…</p>

        <div style="overflow:auto; margin-top:12px;">
          <table style="width:100%; border-collapse:collapse; min-width:900px;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid rgba(255,255,255,.15);">
                <th style="padding:10px;">Time</th>
                <th style="padding:10px;">User</th>
                <th style="padding:10px;">Plan</th>
                <th style="padding:10px;">Amount</th>
                <th style="padding:10px;">Method</th>
                <th style="padding:10px;">TXID</th>
                <th style="padding:10px;">Status</th>
                <th style="padding:10px;">Actions</th>
              </tr>
            </thead>
            <tbody id="paymentsBody"></tbody>
          </table>
        </div>

        <p class="small" id="msg" style="margin-top:10px;"></p>
      </div>
    </div>
  </section>

  <!-- ✅ ONLY ONE SCRIPT -->
<script type="module">
  import { auth, db } from "./js/firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ✅ Your admin UID
  const ADMIN_UIDS = ["40B1eYKROIXFAZLpelBhjjFTDm72"];

  // ✅ IDs that exist in your HTML
  const adminInfo = document.getElementById("adminInfo");
  const msg = document.getElementById("msg");
  const paymentsBody = document.getElementById("paymentsBody");
  const refreshBtn = document.getElementById("refreshBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  async function loadPendingPayments() {
    paymentsBody.innerHTML = "";
    msg.textContent = "Loading pending payments…";

    try {
      const q = query(
        collection(db, "payments"),
        where("status", "==", "pending")
      );

      const snap = await getDocs(q);

      if (snap.empty) {
        msg.textContent = "✅ No pending payments.";
        return;
      }

      msg.textContent = `Found ${snap.size} pending payment(s).`;

      snap.forEach((docSnap) => {
        const p = docSnap.data();
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td style="padding:10px;">${p.email || "-"}</td>
          <td style="padding:10px;">${p.planName || "-"}</td>
          <td style="padding:10px;">$${p.amount ?? "-"}</td>
          <td style="padding:10px;">${p.method || "-"}</td>
          <td style="padding:10px; word-break:break-all;">${p.txid || "-"}</td>
          <td style="padding:10px;">${p.status || "-"}</td>
          <td style="padding:10px;">Pending</td>
        `;

        paymentsBody.appendChild(tr);
      });

    } catch (err) {
      console.error(err);
      msg.textContent = "❌ Firestore error: " + (err?.message || err);
    }
  }

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.replace("login.html");
      return;
    }

    // ✅ Admin check ONCE
    if (!ADMIN_UIDS.includes(user.uid)) {
      adminInfo.textContent = "❌ Access denied (not admin).";
      window.location.replace("dashboard.html");
      return;
    }

    adminInfo.textContent = "✅ Admin verified";
    loadPendingPayments();
  });

  refreshBtn?.addEventListener("click", loadPendingPayments);

  logoutBtn?.addEventListener("click", async () => {
    try { await signOut(auth); } catch (e) {}
    window.location.replace("login.html");
  });
</script>
</body>
</html>
