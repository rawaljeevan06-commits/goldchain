import { auth } from "./js/firebase.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

console.log("✅ Dashboard loaded");

/* ---------- PLAN HELPERS ---------- */
function getPlan() {
  const raw =
    localStorage.getItem("selectedPlan") ||
    sessionStorage.getItem("selectedPlan");

  if (!raw) return null;

  try { return JSON.parse(raw); }
  catch { return null; }
}

function renderPlan() {
  const plan = getPlan();
  const nameEl = document.getElementById("dashPlanName");
  const infoEl = document.getElementById("dashPlanInfo");
  const profitEl = document.getElementById("weeklyProfitValue");

  if (!plan) {
    nameEl.textContent = "Not selected";
    infoEl.textContent = "Go to Plans and choose a plan.";
    profitEl.textContent = "$0.00";
    return;
  }

  nameEl.textContent = plan.name || "Selected Plan";
  infoEl.textContent = `$${plan.amount} • ${plan.percent}% weekly • ${plan.withdraw}`;
  profitEl.textContent = "$0.00";
}

renderPlan();

/* ---------- AUTH PROTECT ---------- */
onAuthStateChanged(auth, (user) => {
  if (!user) {
    location.href = "login.html";
    return;
  }
  const emailEl = document.getElementById("userEmail");
  if (emailEl) emailEl.textContent = user.email || "";
});

/* ---------- BUTTONS ---------- */
document.getElementById("payNowBtn").addEventListener("click", () => {
  if (!getPlan()) {
    alert("No plan selected. Please choose a plan first.");
    location.href = "plans.html";
    return;
  }
  location.href = "payment.html";
});

document.getElementById("clearPlanBtn").addEventListener("click", () => {
  localStorage.removeItem("selectedPlan");
  sessionStorage.removeItem("selectedPlan");
  renderPlan();

  // optional cleanup UI
  document.getElementById("dashCalcResult").style.display = "none";
  document.getElementById("dashAmount").value = "";
  alert("Plan cleared");
});

document.getElementById("dashCalcBtn").addEventListener("click", () => {
  const plan = getPlan();
  const result = document.getElementById("dashCalcResult");

  if (!plan) {
    result.style.display = "block";
    result.textContent = "Please select a plan first.";
    return;
  }

  const amount = Number(document.getElementById("dashAmount").value || 0);
  if (!amount || amount <= 0) {
    result.style.display = "block";
    result.textContent = "Enter a valid amount.";
    return;
  }

  const profit = (amount * Number(plan.percent || 0)) / 100;
  result.style.display = "block";
  result.textContent = `Estimated weekly profit: $${profit.toFixed(2)}`;
  document.getElementById("weeklyProfitValue").textContent = `$${profit.toFixed(2)}`;
});

document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  location.href = "login.html";
});
