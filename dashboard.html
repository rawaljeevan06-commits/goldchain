<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | GoldChain</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>

  <div class="dash-wrap">
    <header class="dash-top">
      <div>
        <h1 class="dash-title">GoldChain Dashboard</h1>
        <p class="dash-sub">You are successfully logged in ✅</p>
        <p id="userEmail" class="dash-email"></p>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="logoutBtn" class="btn btn-logout" type="button">Logout</button>
        <button id="clearPlanBtn" class="btn btn-outline" type="button">Clear Plan</button>
        <button id="payNowBtn" class="btn btn-primary" type="button">Pay Now</button>
        
        <button id="withdrawBtn" class="btn btn-primary" type="button" style="display:none;">
  Withdrawal
</button>

        <!-- ✅ NEW: Only shows after verified -->
        <a id="withdrawBtn" class="btn btn-primary" href="withdrawal.html" style="display:none; text-decoration:none;">
          Withdraw
        </a>
      </div>
    </header>

    <section class="dash-cards">
      <div class="card">
        <h3>Account</h3>
        <p class="muted">Status</p>
        <p class="big">Active ✅</p>
      </div>

      <div class="card">
        <h3>Payment Status</h3>
        <p class="muted" id="paymentStatusText">Checking…</p>
      </div>

      <div class="card">
        <h3>Plan</h3>
        <p class="muted">Current plan</p>
        <p class="big" id="dashPlanName">Not selected</p>
        <p class="muted" id="dashPlanInfo"></p>
      </div>

      <div class="card">
        <h3>Weekly Profit</h3>
        <p class="muted">Estimated</p>
        <p class="big" id="weeklyProfitValue">$0.00</p>
      </div>
    </section>

    <div class="dash-box">
      <h2>Profit Calculator</h2>
      <p class="muted">Enter amount to calculate weekly profit.</p>

      <div class="calc-row">
        <input type="number" id="dashAmount" placeholder="Enter amount in USD" />
        <button class="btn btn-primary" id="dashCalcBtn" type="button">Calculate</button>
      </div>

      <div id="dashCalcResult" class="calc-result" style="display:none;"></div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, where, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    console.log("✅ Dashboard script running");

    // ✅ PUT YOUR ADMIN UID(S) HERE
    const ADMIN_UIDS = ["40B1eYKROIXFAZLpelBhjjFTDm72"];

    // ----------------- ELEMENTS -----------------
    const payNowBtn   = document.getElementById("payNowBtn");
    const clearBtn    = document.getElementById("clearPlanBtn");
    const calcBtn     = document.getElementById("dashCalcBtn");
    const logoutBtn   = document.getElementById("logoutBtn");

    const statusEl    = document.getElementById("paymentStatusText");
    const emailEl     = document.getElementById("userEmail");

    const nameEl      = document.getElementById("dashPlanName");
    const infoEl      = document.getElementById("dashPlanInfo");
    const profitEl    = document.getElementById("weeklyProfitValue");
    const resultEl    = document.getElementById("dashCalcResult");

    const withdrawBtn = document.getElementById("withdrawBtn");
    const withdrawBtn = document.getElementById("withdrawBtn");

withdrawBtn?.addEventListener("click", () => {
  window.location.href = "withdrawal.html";
});
    // ----------------- HELPERS -----------------
    function setStatus(text) {
      if (statusEl) statusEl.textContent = text;
    }

    function money(n) {
      const x = Number(n || 0);
      return `$${x.toFixed(2)}`;
    }

    // Percent rules (fallback)
    function percentByAmount(amount) {
      const a = Number(amount) || 0;
      if (a >= 5000) return 4;
      if (a >= 1000) return 3;
      if (a >= 700)  return 2;
      if (a >= 350)  return 1.5;
      return 0;
    }

    // SAFE storage helpers
    function getStorage(key) {
      try { return localStorage.getItem(key); } catch(e) { return null; }
    }
    function getSession(key) {
      try { return sessionStorage.getItem(key); } catch(e) { return null; }
    }

    // ✅ Handles BOTH:
    // 1) JSON stored plan {name, amount, percent, withdraw}
    // 2) plain string "Basic - $350" or "Growth - $700"
    function loadPlanSafely() {
      const raw = getSession("selectedPlan") || getStorage("selectedPlan");
      if (!raw) return null;

      // Try JSON first
      try {
        const obj = JSON.parse(raw);
        if (obj && typeof obj === "object") {
          const amount = Number(obj.amount || 0);
          return {
            name: obj.name || "Selected Plan",
            amount,
            percent: Number(obj.percent || percentByAmount(amount)),
            withdraw: obj.withdraw || ""
          };
        }
      } catch(e) {}

      // Try parse string
      const amtMatch = raw.match(/(\d{2,})/);
      const amount = amtMatch ? Number(amtMatch[1]) : 0;
      return {
        name: raw.replace(/\s+/g, " ").trim(),
        amount,
        percent: percentByAmount(amount),
        withdraw: ""
      };
    }

    function renderPlan(plan) {
      const p = plan || loadPlanSafely();

      if (!p) {
        nameEl.textContent = "Not selected";
        infoEl.textContent = "";
        profitEl.textContent = "$0.00";
        return;
      }

      nameEl.textContent = p.name || "Selected Plan";
      const withdrawText = p.withdraw ? ` • ${p.withdraw}` : "";
      infoEl.textContent = `$${p.amount} • ${p.percent}% weekly${withdrawText}`;
    }

    function lockUI() {
      // Only show pay now if not verified
      if (withdrawBtn) withdrawBtn.style.display = "none";
    }

    function unlockUI() {
      // Show withdrawal button if verified
      if (withdrawBtn) withdrawBtn.style.display = "inline-flex";
    }

    function renderProfitFromAmount(amount) {
      const plan = loadPlanSafely();
      const pct = plan?.percent ?? percentByAmount(amount);
      const weekly = (Number(amount || 0) * Number(pct || 0)) / 100;
      profitEl.textContent = money(weekly);
    }

    function renderProfitFromPaymentDoc(docData) {
      const amount = Number(docData?.amount || 0);
      renderProfitFromAmount(amount);
    }

    // ----------------- PAYMENT STATUS (MOST IMPORTANT FIX) -----------------
    async function getVerifiedPaymentDoc(user) {
      // ✅ First: look for ANY verified doc for this user (no orderBy needed)
      const q1 = query(
        collection(db, "payments"),
        where("uid", "==", user.uid),
        where("status", "==", "verified"),
        limit(1)
      );

      const snap1 = await getDocs(q1);
      if (!snap1.empty) return snap1.docs[0].data();

      return null;
    }

    async function getLatestPaymentDoc(user) {
      // ✅ Second: latest payment (pending/rejected/etc)
      const q2 = query(
        collection(db, "payments"),
        where("uid", "==", user.uid),
        orderBy("createdAt", "desc"),
        limit(1)
      );

      const snap2 = await getDocs(q2);
      if (!snap2.empty) return snap2.docs[0].data();

      return null;
    }

    async function renderPaymentStatusFromFirestore(user) {
      setStatus("Checking…");

      try {
        const verifiedDoc = await getVerifiedPaymentDoc(user);

        if (verifiedDoc) {
          setStatus("✅ Payment Verified — Full access unlocked");
          unlockUI();

          // Update plan display & profit using Firestore amount
          // (your Firestore doc already has planName + amount)
          if (verifiedDoc.planName && verifiedDoc.amount) {
            // Show plan from Firestore (without breaking your old structure)
            nameEl.textContent = verifiedDoc.planName;
            infoEl.textContent = `$${verifiedDoc.amount} • ${percentByAmount(verifiedDoc.amount)}% weekly`;
            renderProfitFromPaymentDoc(verifiedDoc);
          } else {
            renderPlan();
            const plan = loadPlanSafely();
            if (plan) renderProfitFromAmount(plan.amount);
          }

          return;
        }

        // Not verified yet → show latest status
        const latestDoc = await getLatestPaymentDoc(user);

        if (!latestDoc) {
          setStatus("❌ No payment submitted");
          lockUI();
          return;
        }

        const st = String(latestDoc.status || "").toLowerCase();

        if (st === "pending") {
          setStatus("⏳ Payment Pending — Waiting for verification");
          lockUI();
          return;
        }

        if (st === "rejected") {
          setStatus("❌ Payment Rejected — Please submit again");
          lockUI();
          return;
        }

        // unknown
        setStatus(`ℹ️ Payment Status: ${latestDoc.status || "Unknown"}`);
        lockUI();
      } catch (e) {
        console.error("Firestore payment status failed:", e);
        setStatus("⚠️ Could not read payment status (check Firestore rules/index)");
        lockUI();
      }
    }

    // ----------------- BUTTONS -----------------
    payNowBtn?.addEventListener("click", () => {
      const plan = loadPlanSafely();
      if (!plan) {
        alert("No plan selected. Please choose a plan first.");
        window.location.href = "plans.html";
        return;
      }
      window.location.href = "payment.html";
    });

    clearBtn?.addEventListener("click", () => {
      try { localStorage.removeItem("selectedPlan"); } catch(e) {}
      try { sessionStorage.removeItem("selectedPlan"); } catch(e) {}
      renderPlan();
      profitEl.textContent = "$0.00";
      alert("Plan cleared");
    });

    calcBtn?.addEventListener("click", () => {
      const plan = loadPlanSafely();

      if (!plan) {
        resultEl.style.display = "block";
        resultEl.textContent = "Please select a plan first.";
        return;
      }

      const amount = Number(document.getElementById("dashAmount").value);
      if (!amount || amount <= 0) {
        resultEl.style.display = "block";
        resultEl.textContent = "Enter a valid amount.";
        return;
      }

      const profit = (amount * Number(plan.percent || 0)) / 100;
      resultEl.style.display = "block";
      resultEl.textContent = `Estimated weekly profit: $${profit.toFixed(2)}`;
      profitEl.textContent = money(profit);
    });

    // Logout
    logoutBtn?.addEventListener("click", async () => {
      try { await signOut(auth); } catch(e) {}
      window.location.replace("login.html");
    });

    // ----------------- AUTH PROTECT (ONLY ONE onAuthStateChanged ✅) -----------------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.replace("login.html");
        return;
      }

      // Admin redirect
      if (ADMIN_UIDS.includes(user.uid)) {
        window.location.replace("admin.html");
        return;
      }

      if (emailEl) emailEl.textContent = user.email || "";

      // Always show plan first (local)
      renderPlan();

      // Then check verified/pending from Firestore
      await renderPaymentStatusFromFirestore(user);
    });
// ----------------- LOCK / UNLOCK UI -----------------

function lockUI() {
  const withdrawBtn = document.getElementById("withdrawBtn");
  if (withdrawBtn) withdrawBtn.style.display = "none";
}

function unlockUI() {
  const withdrawBtn = document.getElementById("withdrawBtn");
  if (withdrawBtn) withdrawBtn.style.display = "inline-block";
}

// ----------------- PROFIT CALC FROM VERIFIED PAYMENT -----------------

function renderProfit(paymentDoc) {
  if (!paymentDoc) return;

  const amount = Number(paymentDoc.amount || 0);
  const percent = percentByAmount(amount);

  const weekly = (amount * percent) / 100;

  if (profitEl) {
    profitEl.textContent = `$${weekly.toFixed(2)}`;
  }
}
    // ----------------- INITIAL RENDER -----------------
    renderPlan();
  </script>

</body>
</html>
