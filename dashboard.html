<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | GoldChain</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <div class="dash-wrap">
    <header class="dash-top">
      <div>
        <h1 class="dash-title">GoldChain Dashboard</h1>
        <p class="dash-sub">You are successfully logged in ✅</p>
        <p id="userEmail" class="dash-email"></p>
      </div>

      <!-- ✅ BUTTON BAR (same structure) -->
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="logoutBtn" class="btn btn-logout" type="button">Logout</button>
        <button id="clearPlanBtn" class="btn btn-outline" type="button">Clear Plan</button>
        <button id="payNowBtn" class="btn btn-primary" type="button">Pay Now</button>

        <!-- ✅ Withdraw button (hidden until verified) -->
        <button id="withdrawBtn" class="btn btn-primary" type="button" style="display:none;">
          Withdrawal
        </button>
      </div>
    </header>

    <section class="dash-cards">
      <div class="card">
        <h3>Account</h3>
        <p class="muted">Status</p>
        <p class="big">Active ✅</p>
      </div>

      <div class="card">
        <h3>Payment Status</h3>
        <p class="muted" id="paymentStatusText">Checking…</p>
      </div>

      <div class="card">
        <h3>Plan</h3>
        <p class="muted">Current plan</p>
        <p class="big" id="dashPlanName">Not selected</p>
        <p class="muted" id="dashPlanInfo"></p>
      </div>

      <div class="card">
        <h3>Weekly Profit</h3>
        <p class="muted">Estimated</p>
        <p class="big" id="weeklyProfitValue">$0.00</p>
      </div>

      <!-- ✅ Available balance (kept) -->
      <div class="card">
        <h3>Available Balance</h3>
        <p class="muted">Earned - Approved Withdrawals</p>
        <p class="big" id="availableBalanceValue">$0.00</p>
        <p class="muted" id="withdrawLockInfo"></p>
      </div>

      <!-- ✅ NEW (B): Total earned / total withdrawn -->
      <div class="card">
        <h3>Total Earned</h3>
        <p class="muted">Since verification</p>
        <p class="big" id="totalEarnedValue">$0.00</p>
      </div>

      <div class="card">
        <h3>Total Withdrawn</h3>
        <p class="muted">Approved withdrawals</p>
        <p class="big" id="totalWithdrawnValue">$0.00</p>
      </div>
    </section>

    <div class="dash-box">
      <h2>Profit Calculator</h2>
      <p class="muted">Enter amount to calculate weekly profit.</p>

      <div class="calc-row">
        <input type="number" id="dashAmount" placeholder="Enter amount in USD" />
        <button class="btn btn-primary" id="dashCalcBtn" type="button">Calculate</button>
      </div>

      <div id="dashCalcResult" class="calc-result" style="display:none;"></div>
    </div>

    <!-- ✅ NEW (A): Withdrawal History table (same style as admin tables) -->
    <div class="dash-box" style="margin-top:18px;">
      <h2>Withdrawal History</h2>
      <p class="muted">Your recent withdrawal requests.</p>
      <p class="small" id="whMsg" style="margin-top:8px;"></p>

      <div style="overflow:auto; margin-top:12px;">
        <table style="width:100%; border-collapse:collapse; min-width:900px;">
          <thead>
            <tr style="text-align:left; border-bottom:1px solid rgba(255,255,255,.15);">
              <th style="padding:10px;">Time</th>
              <th style="padding:10px;">Amount</th>
              <th style="padding:10px;">Wallet</th>
              <th style="padding:10px;">Status</th>
            </tr>
          </thead>
          <tbody id="withdrawHistoryBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { collection, query, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ Admin UID
    const ADMIN_UIDS = ["40B1eYKROIXFAZLpelBhjjFTDm72"];

    // Elements
    const payNowBtn   = document.getElementById("payNowBtn");
    const clearBtn    = document.getElementById("clearPlanBtn");
    const calcBtn     = document.getElementById("dashCalcBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const withdrawBtn = document.getElementById("withdrawBtn");

    const statusEl    = document.getElementById("paymentStatusText");
    const emailEl     = document.getElementById("userEmail");

    const nameEl      = document.getElementById("dashPlanName");
    const infoEl      = document.getElementById("dashPlanInfo");
    const profitEl    = document.getElementById("weeklyProfitValue");
    const availEl     = document.getElementById("availableBalanceValue");
    const lockInfoEl  = document.getElementById("withdrawLockInfo");

    const totalEarnedEl    = document.getElementById("totalEarnedValue");
    const totalWithdrawnEl = document.getElementById("totalWithdrawnValue");

    const whMsgEl = document.getElementById("whMsg");
    const withdrawHistoryBody = document.getElementById("withdrawHistoryBody");

    const resultEl    = document.getElementById("dashCalcResult");

    function money(n){ return `$${Number(n||0).toFixed(2)}`; }
    function setStatus(t){ if(statusEl) statusEl.textContent = t; }

    function esc(s) {
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }
    function formatTime(ts) {
      try {
        if (!ts) return "-";
        if (typeof ts.toDate === "function") return ts.toDate().toLocaleString();
        return new Date(ts).toLocaleString();
      } catch { return "-"; }
    }

    function percentByAmount(amount){
      const a = Number(amount)||0;
      if (a >= 5000) return 4;
      if (a >= 1000) return 3;
      if (a >= 700)  return 2;
      if (a >= 350)  return 1.5;
      return 0;
    }

    function lockDaysByAmount(amount){
      const a = Number(amount)||0;
      if (a >= 5000) return 7;   // weekly
      if (a >= 1000) return 15;
      if (a >= 700)  return 30;
      if (a >= 350)  return 45;
      return 999999;
    }

    function tsToDate(x){
      try{
        if(!x) return null;
        if(typeof x.toDate==="function") return x.toDate();
        return new Date(x);
      }catch{ return null; }
    }

    function daysBetween(d1, d2){
      const ms = (d2 - d1);
      return Math.floor(ms / (1000*60*60*24));
    }

    // ✅ INDEX-FREE (no extra Firestore indexes needed)
    async function getVerifiedPayment(user){
      const qv = query(collection(db, "payments"), where("uid", "==", user.uid), limit(50));
      const snap = await getDocs(qv);
      if (snap.empty) return null;

      for (const d of snap.docs) {
        const p = d.data();
        if (String(p.status||"").toLowerCase() === "verified") return { id: d.id, ...p };
      }
      return null;
    }

    async function getWithdrawals(user){
      const qx = query(collection(db, "withdrawals"), where("uid", "==", user.uid), limit(200));
      const snap = await getDocs(qx);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function getApprovedWithdrawalSum(user){
      const ws = await getWithdrawals(user);
      return ws
        .filter(w => String(w.status||"").toLowerCase() === "approved")
        .reduce((a,w) => a + Number(w.amount||0), 0);
    }

    async function hasPendingWithdrawal(user){
      const ws = await getWithdrawals(user);
      return ws.some(w => String(w.status||"").toLowerCase() === "pending");
    }

    function unlockUI(){ if(withdrawBtn) withdrawBtn.style.display="inline-flex"; }
    function lockUI(){ if(withdrawBtn) withdrawBtn.style.display="none"; }

    function renderPlanFromVerified(verifiedDoc){
      const principal = Number(verifiedDoc?.amount || 0);
      const pct = percentByAmount(principal);

      nameEl.textContent = verifiedDoc?.planName || "Verified Plan";
      infoEl.textContent = `$${principal} • ${pct}% weekly`;
      profitEl.textContent = money((principal * pct)/100);
    }

    async function loadWithdrawalHistory(user){
      if (!withdrawHistoryBody) return;

      withdrawHistoryBody.innerHTML = "";
      if (whMsgEl) whMsgEl.textContent = "Loading…";

      try {
        const ws = await getWithdrawals(user);

        if (!ws.length) {
          if (whMsgEl) whMsgEl.textContent = "No withdrawals yet.";
          return;
        }

        // Sort locally by createdAt if possible
        ws.sort((a,b) => {
          const ad = tsToDate(a.createdAt || a.processedAt) || new Date(0);
          const bd = tsToDate(b.createdAt || b.processedAt) || new Date(0);
          return bd - ad;
        });

        const top = ws.slice(0, 50);
        if (whMsgEl) whMsgEl told = ""; // (ignored by browser if typo, but safe)
        if (whMsgEl) whMsgEl.textContent = `Showing ${top.length} item(s).`;

        top.forEach((w) => {
          const tr = document.createElement("tr");
          tr.style.borderBottom = "1px solid rgba(255,255,255,.08)";
          tr.innerHTML = `
            <td style="padding:10px;">${esc(formatTime(w.createdAt || w.processedAt))}</td>
            <td style="padding:10px;">$${esc(w.amount ?? "-")}</td>
            <td style="padding:10px; max-width:360px; word-break:break-all;">${esc(w.wallet || w.walletAddress || "-")}</td>
            <td style="padding:10px;">${esc(w.status || "-")}</td>
          `;
          withdrawHistoryBody.appendChild(tr);
        });

      } catch (e) {
        console.error(e);
        if (whMsgEl) whMsgEl.textContent = "Failed to load history (rules).";
      }
    }

    async function renderAccountAccess(user){
      setStatus("Checking…");
      lockUI();

      availEl.textContent = "$0.00";
      lockInfoEl.textContent = "";
      if (totalEarnedEl) totalEarnedEl.textContent = "$0.00";
      if (totalWithdrawnEl) totalWithdrawnEl.textContent = "$0.00";

      const verified = await getVerifiedPayment(user);

      if(!verified){
        setStatus("⏳ Payment Pending — Waiting for verification");
        nameEl.textContent = "Not selected";
        infoEl.textContent = "";
        profitEl.textContent = "$0.00";
        if (whMsgEl) whMsgEl.textContent = "";
        if (withdrawHistoryBody) withdrawHistoryBody.innerHTML = "";
        return;
      }

      setStatus("✅ Payment Verified — Full access unlocked");
      unlockUI();
      renderPlanFromVerified(verified);

      const principal = Number(verified.amount||0);
      const pct = percentByAmount(principal);
      const lockDays = lockDaysByAmount(principal);

      const vAt = tsToDate(verified.verifiedAt || verified.createdAt);
      const now = new Date();
      const days = vAt ? daysBetween(vAt, now) : 0;

      // Earned profit since verified (daily based)
      const earned = (principal * (pct/100)) * (days/7);

      const approvedSum = await getApprovedWithdrawalSum(user);
      const pending = await hasPendingWithdrawal(user);

      const available = Math.max(0, earned - approvedSum);

      availEl.textContent = money(available);
      if (totalEarnedEl) totalEarnedEl.textContent = money(earned);
      if (totalWithdrawnEl) totalWithdrawnEl.textContent = money(approvedSum);

      if(vAt){
        if(days < lockDays){
          lockInfoEl.textContent = `Withdrawal locked for ${lockDays - days} more day(s) (plan rule).`;
        } else {
          lockInfoEl.textContent = pending
            ? "Withdrawal already submitted (pending approval)."
            : "Withdrawal available.";
        }
      }

      await loadWithdrawalHistory(user);
    }

    // Buttons
    payNowBtn?.addEventListener("click", () => window.location.href="payment.html");
    withdrawBtn?.addEventListener("click", () => window.location.href="withdrawal.html");

    clearBtn?.addEventListener("click", () => {
      try{ localStorage.removeItem("selectedPlan"); }catch(e){}
      try{ sessionStorage.removeItem("selectedPlan"); }catch(e){}
      alert("Plan cleared");
      window.location.reload();
    });

    calcBtn?.addEventListener("click", () => {
      const amount = Number(document.getElementById("dashAmount").value);
      if(!amount || amount<=0){
        resultEl.style.display="block";
        resultEl.textContent="Enter a valid amount.";
        return;
      }
      const pct = percentByAmount(amount);
      const profit = (amount * pct)/100;
      resultEl.style.display="block";
      resultEl.textContent = `Estimated weekly profit: $${profit.toFixed(2)}`;
      profitEl.textContent = money(profit);
    });

    logoutBtn?.addEventListener("click", async () => {
      try{ await signOut(auth); }catch(e){}
      window.location.replace("login.html");
    });

    // ✅ Only ONE auth listener
    onAuthStateChanged(auth, async (user) => {
      if(!user){ window.location.replace("login.html"); return; }
      if(ADMIN_UIDS.includes(user.uid)){ window.location.replace("admin.html"); return; }
      if(emailEl) emailEl.textContent = user.email || "";
      await renderAccountAccess(user);
    });
  </script>
</body>
</html>
