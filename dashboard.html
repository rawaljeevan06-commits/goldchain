<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | GoldChain</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

  <div class="topbar">GoldChain Dashboard — Secure Access</div>

  <header class="header">
    <div class="container header-in">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="GoldChain Logo">
        <span>GoldChain</span>
      </a>

      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="plans.html">Plans</a>
      </nav>

      <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="logoutBtn" class="btn btn-logout" type="button">Logout</button>
        <button id="clearPlanBtn" class="btn btn-outline" type="button">Clear Plan</button>
        <button id="payNowBtn" class="btn btn-primary" type="button">Pay Now</button>
        <button id="withdrawBtn" class="btn btn-primary" type="button">Withdrawal</button>
      </div>
    </div>
  </header>

  <section class="section">
    <div class="container">

      <div class="card">
        <h1>GoldChain Dashboard</h1>
        <p class="small">
          You are successfully logged in ✅
          <br>
          <strong id="emailEl">Checking…</strong>
        </p>
      </div>

      <div class="dash-cards" style="margin-top:14px;">
        <div class="card">
          <h3>Account</h3>
          <p class="muted">Status</p>
          <p class="big" id="accountStatus">Checking…</p>
        </div>

        <div class="card">
          <h3>Payment Status</h3>
          <p class="big" id="payStatus">Checking…</p>
        </div>

        <div class="card">
          <h3>Plan</h3>
          <p class="muted">Current plan</p>
          <p class="big" id="planEl">Not selected</p>
          <p class="small" id="planPctEl" style="opacity:.8;"></p>
        </div>

        <div class="card">
          <h3>Weekly Profit</h3>
          <p class="muted">Estimated</p>
          <p class="big" id="weeklyProfitEl">$0.00</p>
        </div>

        <div class="card">
          <h3>Available Balance</h3>
          <p class="muted">Earned - Approved Withdrawals</p>
          <p class="big" id="balanceEl">$0.00</p>
          <p class="small" id="balanceNote" style="opacity:.8;"></p>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <h2>Profit Calculator</h2>
        <p class="small">Enter amount to calculate weekly profit.</p>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;">
          <input id="amountInput" type="number" min="0" step="1" placeholder="Enter amount in USD"
                 style="padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0e0f12; color:#fff; width:240px;">
          <button id="calcBtn" class="btn btn-primary" type="button">Calculate</button>
        </div>

        <p class="small" id="resultEl" style="margin-top:10px; display:none;"></p>
      </div>

      <!-- ✅ KEEP ONLY ONE HISTORY (no duplicate IDs) -->
      <div class="card" style="margin-top:14px;">
        <h2>History</h2>
        <p class="small" id="historyMsg">Loading history…</p>

        <hr style="margin:18px 0; opacity:.25;">

        <h3>Payment History</h3>
        <div style="overflow:auto; margin-top:10px;">
          <table style="width:100%; border-collapse:collapse; min-width:900px;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid rgba(255,255,255,.15);">
                <th style="padding:10px;">Time</th>
                <th style="padding:10px;">Plan</th>
                <th style="padding:10px;">Amount</th>
                <th style="padding:10px;">Method</th>
                <th style="padding:10px;">TXID</th>
                <th style="padding:10px;">Status</th>
              </tr>
            </thead>
            <tbody id="payHistoryBody"></tbody>
          </table>
        </div>

        <hr style="margin:18px 0; opacity:.25;">

        <h3>Withdrawal History</h3>
        <div style="overflow:auto; margin-top:10px;">
          <table style="width:100%; border-collapse:collapse; min-width:900px;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid rgba(255,255,255,.15);">
                <th style="padding:10px;">Time</th>
                <th style="padding:10px;">Amount</th>
                <th style="padding:10px;">Wallet</th>
                <th style="padding:10px;">Status</th>
              </tr>
            </thead>
            <tbody id="wdHistoryBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, where, limit, getDocs,
      doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ Admin UIDs (same list as admin.html)
    const ADMIN_UIDS = ["40B1eYKROIXFAZLpelBhjjFTDm72"];

    // Elements
    const emailEl = document.getElementById("emailEl");
    const accountStatus = document.getElementById("accountStatus");
    const payStatus = document.getElementById("payStatus");
    const planEl = document.getElementById("planEl");
    const planPctEl = document.getElementById("planPctEl");
    const weeklyProfitEl = document.getElementById("weeklyProfitEl");
    const balanceEl = document.getElementById("balanceEl");
    const balanceNote = document.getElementById("balanceNote");

    const amountInput = document.getElementById("amountInput");
    const calcBtn = document.getElementById("calcBtn");
    const resultEl = document.getElementById("resultEl");

    const payHistoryBody = document.getElementById("payHistoryBody");
    const wdHistoryBody = document.getElementById("wdHistoryBody");
    const historyMsg = document.getElementById("historyMsg");

    const logoutBtn = document.getElementById("logoutBtn");
    const clearPlanBtn = document.getElementById("clearPlanBtn");
    const payNowBtn = document.getElementById("payNowBtn");
    const withdrawBtn = document.getElementById("withdrawBtn");

    // Helpers
    function esc(s) {
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function tsToMillis(ts){
      try{
        if(!ts) return 0;
        if(typeof ts.toDate === "function") return ts.toDate().getTime(); // Firestore Timestamp
        const d = new Date(ts);
        return isNaN(d.getTime()) ? 0 : d.getTime();
      }catch{
        return 0;
      }
    }

    function formatTime(ts) {
      try {
        if (!ts) return "-";
        if (typeof ts.toDate === "function") return ts.toDate().toLocaleString();
        return new Date(ts).toLocaleString();
      } catch { return "-"; }
    }

    function money(n) {
      const x = Number(n || 0);
      if (!Number.isFinite(x)) return "$0.00";
      return "$" + x.toFixed(2);
    }

    // Plan storage
    function loadSelectedPlan() {
      let plan = "";
      try { plan = localStorage.getItem("selectedPlan") || ""; } catch(e){}
      if (!plan) {
        try { plan = sessionStorage.getItem("selectedPlan") || ""; } catch(e){}
      }
      return plan;
    }

    function percentByAmount(amount) {
      const a = Number(amount || 0);
      if (!Number.isFinite(a) || a <= 0) return 0;
      if (a >= 5000) return 4;
      if (a >= 1000) return 3;
      if (a >= 700) return 2;
      if (a >= 350) return 1.5;
      return 0;
    }

    function parseAmountFromPlan(planText) {
      // finds first number (supports $700, 700)
      const m = String(planText || "").match(/([0-9]+(\.[0-9]+)?)/);
      if (!m) return 0;
      return Number(m[1]) || 0;
    }

    function parsePlan(raw) {
      if (!raw) return null;
      const s = String(raw).trim();

      // JSON string?
      if (s.startsWith("{") && s.endsWith("}")) {
        try {
          const obj = JSON.parse(s);
          return obj && typeof obj === "object" ? obj : null;
        } catch (e) {
          return null;
        }
      }

      // plain text
      return { name: s };
    }

    async function renderAccountAccess(user) {
      // Plan
      const rawPlan = loadSelectedPlan();
      const planObj = parsePlan(rawPlan);

      const planName = planObj?.name || "Not selected";
      const planAmount = Number(planObj?.amount || parseAmountFromPlan(rawPlan) || 0);
      const pct = Number(planObj?.percent || percentByAmount(planAmount) || 0);
      const withdrawText =
        planObj?.withdraw || planObj?.withdrawDays || planObj?.withdrawal || "";

      planEl.textContent = planName;
      planPctEl.textContent = pct ? `${pct}% weekly${withdrawText ? " • " + withdrawText : ""}` : "";

      // Weekly estimate
      const weekly = pct ? (planAmount * pct) / 100 : 0;
      weeklyProfitEl.textContent = money(weekly);

      // Balance from users/{uid}.balance
      try {
        const uRef = doc(db, "users", user.uid);
        const uSnap = await getDoc(uRef);
        const bal = uSnap.exists() ? Number(uSnap.data()?.balance || 0) : 0;
        balanceEl.textContent = money(bal);
        balanceNote.textContent = bal > 0 ? "Withdrawal available." : "No earnings yet.";
      } catch (e) {
        console.warn("Balance load failed:", e);
        balanceEl.textContent = "$0.00";
        balanceNote.textContent = "Could not load balance.";
      }

      // Payment verified (index-free: read, then check in JS)
      payStatus.textContent = "Checking…";
      try {
        const snap = await getDocs(query(
          collection(db, "payments"),
          where("uid", "==", user.uid),
          limit(50)
        ));
        const verified = snap.docs.some(d => String(d.data()?.status || "").toLowerCase() === "verified");
        payStatus.textContent = verified
          ? "✅ Payment Verified — Full access unlocked"
          : "⏳ Not verified — Please complete payment";
      } catch (e) {
        console.warn("Payment check failed:", e);
        payStatus.textContent = "⚠️ Could not check payment";
      }

      accountStatus.textContent = "Active ✅";
    }

    async function loadHistoryForUser(user) {
      if (historyMsg) historyMsg.textContent = "Loading history…";

      // Payments history (index-free, sort locally)
      try {
        if (payHistoryBody) payHistoryBody.innerHTML = "";

        const pSnap = await getDocs(query(
          collection(db, "payments"),
          where("uid", "==", user.uid),
          limit(50)
        ));

        const arr = pSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        arr.sort((a,b) => tsToMillis(b.createdAt) - tsToMillis(a.createdAt));

        if (!arr.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td style="padding:10px;" colspan="6">No payments yet.</td>`;
          payHistoryBody?.appendChild(tr);
        } else {
          arr.slice(0, 20).forEach(p => {
            const tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid rgba(255,255,255,.08)";
            tr.innerHTML = `
              <td style="padding:10px;">${esc(formatTime(p.createdAt))}</td>
              <td style="padding:10px;">${esc(p.planName || "-")}</td>
              <td style="padding:10px;">$${esc(p.amount ?? "-")}</td>
              <td style="padding:10px;">${esc(p.method || "-")}</td>
              <td style="padding:10px; max-width:260px; word-break:break-all;">${esc(p.txid || "-")}</td>
              <td style="padding:10px;">${esc(p.status || "-")}</td>
            `;
            payHistoryBody?.appendChild(tr);
          });
        }
      } catch (e) {
        console.error("Payments history error:", e);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td style="padding:10px;" colspan="6">Failed to load payments history.</td>`;
        payHistoryBody?.appendChild(tr);
      }

      // Withdrawals history (index-free, sort locally)
      try {
        if (wdHistoryBody) wdHistoryBody.innerHTML = "";

        const wSnap = await getDocs(query(
          collection(db, "withdrawals"),
          where("uid", "==", user.uid),
          limit(50)
        ));

        const arr = wSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        arr.sort((a,b) => tsToMillis(b.createdAt) - tsToMillis(a.createdAt));

        if (!arr.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td style="padding:10px;" colspan="4">No withdrawals yet.</td>`;
          wdHistoryBody?.appendChild(tr);
        } else {
          arr.slice(0, 20).forEach(w => {
            const tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid rgba(255,255,255,.08)";
            tr.innerHTML = `
              <td style="padding:10px;">${esc(formatTime(w.createdAt))}</td>
              <td style="padding:10px;">$${esc(w.amount ?? "-")}</td>
              <td style="padding:10px; max-width:320px; word-break:break-all;">${esc(w.wallet || w.walletAddress || "-")}</td>
              <td style="padding:10px;">${esc(w.status || "-")}</td>
            `;
            wdHistoryBody?.appendChild(tr);
          });
        }
      } catch (e) {
        console.error("Withdrawals history error:", e);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td style="padding:10px;" colspan="4">Failed to load withdrawals history.</td>`;
        wdHistoryBody?.appendChild(tr);
      }

      if (historyMsg) historyMsg.textContent = "✅ History loaded.";
    }

    // Profit calculator
    calcBtn?.addEventListener("click", () => {
      const amount = Number(amountInput?.value || 0);
      if (!amount || amount <= 0) {
        resultEl.style.display = "block";
        resultEl.textContent = "Enter a valid amount.";
        return;
      }
      const pct = percentByAmount(amount);
      if (!pct) {
        resultEl.style.display = "block";
        resultEl.textContent = "Amount is below minimum plan ($350).";
        return;
      }
      const profit = (amount * pct) / 100;
      resultEl.style.display = "block";
      resultEl.textContent = `Estimated weekly profit: $${profit.toFixed(2)} (${pct}% weekly)`;
    });

    // Buttons
    logoutBtn?.addEventListener("click", async () => {
      try { await signOut(auth); } catch(e){}
      // After logout, Firebase may still cache for a moment; this forces login page
      window.location.replace("login.html");
    });

    clearPlanBtn?.addEventListener("click", () => {
      try { localStorage.removeItem("selectedPlan"); } catch(e){}
      try { sessionStorage.removeItem("selectedPlan"); } catch(e){}
      planEl.textContent = "Not selected";
      planPctEl.textContent = "";
      weeklyProfitEl.textContent = "$0.00";
      alert("Plan cleared.");
    });

    payNowBtn?.addEventListener("click", () => {
      const plan = loadSelectedPlan();
      if (!plan) {
        alert("No plan selected. Please choose a plan first.");
        window.location.href = "plans.html";
        return;
      }
      window.location.href = "payment.html";
    });

    withdrawBtn?.addEventListener("click", () => {
      window.location.href = "withdrawal.html";
    });

    // ✅ ONLY ONE auth listener
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.replace("login.html");
        return;
      }

      // admin redirect
      if (ADMIN_UIDS.includes(user.uid)) {
        window.location.replace("admin.html");
        return;
      }

      if (emailEl) emailEl.textContent = user.email || user.uid;

      await renderAccountAccess(user);
      await loadHistoryForUser(user);
    });
  </script>

</body>
</html>
