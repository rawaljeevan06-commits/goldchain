<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Withdrawal | GoldChain</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

  <div class="dash-wrap">
    <header class="dash-top">
      <div>
        <h1 class="dash-title">Withdrawal</h1>
        <p class="dash-sub">Request withdrawal after payment verification ✅</p>
        <p id="userEmail" class="dash-email"></p>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="backBtn" class="btn btn-outline" type="button">Back</button>
        <button id="logoutBtn" class="btn btn-logout" type="button">Logout</button>
      </div>
    </header>

    <section class="dash-cards">
      <div class="card">
        <h3>Status</h3>
        <p class="big" id="statusText">Checking…</p>
        <p class="muted" id="lockInfo"></p>
      </div>

      <div class="card">
        <h3>Plan</h3>
        <p class="muted">Verified plan</p>
        <p class="big" id="planText">—</p>
      </div>

      <div class="card">
        <h3>Weekly Profit</h3>
        <p class="muted">Estimated</p>
        <p class="big" id="weeklyProfit">$0.00</p>
      </div>

      <div class="card">
        <h3>Available Balance</h3>
        <p class="muted">Earned - Approved Withdrawals</p>
        <p class="big" id="available">$0.00</p>
      </div>
    </section>

    <div class="dash-box">
      <h2>Request Withdrawal</h2>
      <p class="muted">Fill details below and submit your request.</p>

      <div class="calc-row">
        <input type="number" id="amount" placeholder="Amount (USD)" />
      </div>

      <div class="calc-row" style="margin-top:10px;">
        <input type="text" id="wallet" placeholder="Wallet Address (USDT/BTC/ETH)" />
      </div>

      <div class="calc-row" style="margin-top:10px;">
        <input type="text" id="note" placeholder="Note (optional)" />
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-primary" id="submitBtn" type="button">Submit Request</button>
        <p class="small" id="msg" style="margin:0;"></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, where, limit, getDocs, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const emailEl = document.getElementById("userEmail");
    const statusText = document.getElementById("statusText");
    const lockInfo = document.getElementById("lockInfo");
    const planText = document.getElementById("planText");
    const weeklyProfitEl = document.getElementById("weeklyProfit");
    const availableEl = document.getElementById("available");

    const amountEl = document.getElementById("amount");
    const walletEl = document.getElementById("wallet");
    const noteEl = document.getElementById("note");
    const submitBtn = document.getElementById("submitBtn");
    const msg = document.getElementById("msg");

    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "dashboard.html";
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try { await signOut(auth); } catch(e) {}
      window.location.replace("login.html");
    });

    function money(n){ return `$${Number(n||0).toFixed(2)}`; }

    function percentByAmount(amount){
      const a = Number(amount)||0;
      if (a >= 5000) return 4;
      if (a >= 1000) return 3;
      if (a >= 700)  return 2;
      if (a >= 350)  return 1.5;
      return 0;
    }

    function lockDaysByAmount(amount){
      const a = Number(amount)||0;
      if (a >= 5000) return 7;    // weekly
      if (a >= 1000) return 15;
      if (a >= 700)  return 30;
      if (a >= 350)  return 45;
      return 999999;
    }

    function tsToDate(x){
      try{
        if(!x) return null;
        if(typeof x.toDate==="function") return x.toDate();
        return new Date(x);
      }catch{ return null; }
    }

    function daysBetween(d1, d2){
      const ms = (d2 - d1);
      return Math.floor(ms / (1000*60*60*24));
    }

    // index-free verified payment
    async function getVerifiedPayment(user){
      const qv = query(collection(db, "payments"), where("uid", "==", user.uid), limit(20));
      const snap = await getDocs(qv);
      if (snap.empty) return null;

      for (const d of snap.docs) {
        const p = d.data();
        if (String(p.status||"").toLowerCase() === "verified") return { id: d.id, ...p };
      }
      return null;
    }

    // index-free withdrawals list
    async function getWithdrawals(user){
      const qx = query(collection(db, "withdrawals"), where("uid", "==", user.uid), limit(200));
      const snap = await getDocs(qx);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    function setMsg(t){ msg.textContent = t; }

    let state = {
      user: null,
      verified: null,
      available: 0,
      locked: true,
      pendingExists: false
    };

    async function computeAvailability(user, verified){
      const principal = Number(verified.amount||0);
      const pct = percentByAmount(principal);
      const lockDays = lockDaysByAmount(principal);

      const vAt = tsToDate(verified.verifiedAt || verified.createdAt);
      const now = new Date();
      const days = vAt ? daysBetween(vAt, now) : 0;

      const earned = (principal * (pct/100)) * (days/7);

      const ws = await getWithdrawals(user);
      const approvedSum = ws
        .filter(w => String(w.status||"").toLowerCase() === "approved")
        .reduce((a,w) => a + Number(w.amount||0), 0);

      const pendingExists = ws.some(w => String(w.status||"").toLowerCase() === "pending");

      const available = Math.max(0, earned - approvedSum);
      const locked = (days < lockDays);

      return { principal, pct, lockDays, days, earned, approvedSum, available, locked, pendingExists };
    }

    async function render(){
      statusText.textContent = "Checking…";
      lockInfo.textContent = "";
      planText.textContent = "—";
      weeklyProfitEl.textContent = "$0.00";
      availableEl.textContent = "$0.00";
      submitBtn.disabled = true;

      const user = state.user;
      const verified = await getVerifiedPayment(user);

      if(!verified){
        statusText.textContent = "⏳ Not verified yet";
        lockInfo.textContent = "You must have a verified payment to request withdrawal.";
        setMsg("");
        return;
      }

      state.verified = verified;

      const { principal, pct, lockDays, days, available, locked, pendingExists } =
        await computeAvailability(user, verified);

      state.available = available;
      state.locked = locked;
      state.pendingExists = pendingExists;

      statusText.textContent = "✅ Verified — You can request withdrawal";
      planText.textContent = `${verified.planName || "Plan"} ($${principal} • ${pct}% weekly)`;
      weeklyProfitEl.textContent = money((principal*pct)/100);
      availableEl.textContent = money(available);

      if(locked){
        lockInfo.textContent = `Withdrawal locked for ${lockDays - days} more day(s) (plan rule).`;
        submitBtn.disabled = true;
        return;
      }

      if(pendingExists){
        lockInfo.textContent = "Withdrawal already submitted (pending approval).";
        submitBtn.disabled = true;
        return;
      }

      if(available <= 0){
        lockInfo.textContent = "No available balance yet.";
        submitBtn.disabled = true;
        return;
      }

      lockInfo.textContent = "Withdrawal available.";
      submitBtn.disabled = false;
    }

    submitBtn.addEventListener("click", async () => {
      try{
        setMsg("");

        if(!state.user || !state.verified){
          setMsg("Not ready. Please refresh.");
          return;
        }

        if(state.locked){
          setMsg("Withdrawal is still locked by plan rule.");
          return;
        }

        if(state.pendingExists){
          setMsg("You already have a pending request.");
          return;
        }

        const amount = Number(amountEl.value);
        const wallet = String(walletEl.value || "").trim();
        const note = String(noteEl.value || "").trim();

        if(!amount || amount <= 0){
          setMsg("Enter a valid amount.");
          return;
        }
        if(!wallet){
          setMsg("Enter wallet address.");
          return;
        }
        if(amount > state.available){
          setMsg(`Amount exceeds available balance (${money(state.available)}).`);
          return;
        }

        submitBtn.disabled = true;
        setMsg("Submitting…");

        await addDoc(collection(db, "withdrawals"), {
          uid: state.user.uid,
          email: state.user.email || "",
          amount,
          wallet,
          note,
          status: "pending",
          planName: state.verified.planName || "",
          planAmount: Number(state.verified.amount || 0),
          createdAt: serverTimestamp()
        });

        setMsg("✅ Withdrawal request submitted (pending).");
        await render();
      } catch(e){
        console.error(e);
        setMsg("❌ Submit failed. Check Firestore rules.");
        submitBtn.disabled = false;
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        window.location.replace("login.html");
        return;
      }
      state.user = user;
      if(emailEl) emailEl.textContent = user.email || "";
      await render();
    });
  </script>
</body>
</html>
