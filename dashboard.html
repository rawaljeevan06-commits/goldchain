<script type="module">
  import { auth } from "./js/firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  console.log("✅ dashboard module loaded");

  // Elements
  const userEmail = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");
  const clearPlanBtn = document.getElementById("clearPlanBtn");
  const payNowBtn = document.getElementById("payNowBtn");

  const dashPlanName = document.getElementById("dashPlanName");
  const dashPlanInfo = document.getElementById("dashPlanInfo");
  const weeklyProfitValue = document.getElementById("weeklyProfitValue");

  const dashAmount = document.getElementById("dashAmount");
  const dashCalcBtn = document.getElementById("dashCalcBtn");
  const dashCalcResult = document.getElementById("dashCalcResult");

  // Protect dashboard + show email
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.replace("login.html");
      return;
    }
    if (userEmail) userEmail.textContent = user.email || "";
  });

  // Helper: get selected plan (JSON)
  function getSelectedPlan() {
    const raw = localStorage.getItem("selectedPlan");
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  // Helper: render plan on UI
  function renderPlan() {
    const plan = getSelectedPlan();

    if (!plan) {
      if (dashPlanName) dashPlanName.textContent = "Not selected";
      if (dashPlanInfo) dashPlanInfo.textContent = "";
      if (weeklyProfitValue) weeklyProfitValue.textContent = "$0.00";
      return null;
    }

    if (dashPlanName) dashPlanName.textContent = plan.name || "Selected";
    if (dashPlanInfo) {
      dashPlanInfo.textContent =
        `${plan.amount ? "$" + plan.amount : ""} • ${plan.percent ? plan.percent + "% weekly" : ""} • ${plan.withdraw || ""}`.trim();
    }

    return plan;
  }

  // Render plan on load
  renderPlan();

  // Logout
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      await signOut(auth);
      window.location.replace("login.html");
    });
  }

  // Clear Plan
  if (clearPlanBtn) {
    clearPlanBtn.addEventListener("click", () => {
      localStorage.removeItem("selectedPlan");
      renderPlan();
      if (dashCalcResult) dashCalcResult.style.display = "none";
      alert("✅ Plan cleared");
    });
  }

  // Pay Now
  if (payNowBtn) {
    payNowBtn.addEventListener("click", () => {
      const plan = getSelectedPlan();
      if (!plan) {
        alert("No plan selected. Please choose a plan first.");
        window.location.href = "plans.html";
        return;
      }
      window.location.href = "payment.html";
    });
  }

  // Calculator
  if (dashCalcBtn) {
    dashCalcBtn.addEventListener("click", () => {
      const plan = getSelectedPlan();
      if (!plan) {
        dashCalcResult.style.display = "block";
        dashCalcResult.textContent = "Please select a plan first (Plans → Pay Now).";
        return;
      }

      const amount = Number(dashAmount.value || 0);
      const rate = Number(plan.percent || 0);

      if (!amount || amount <= 0) {
        dashCalcResult.style.display = "block";
        dashCalcResult.textContent = "Enter a valid amount.";
        return;
      }

      const profit = (amount * rate) / 100;
      weeklyProfitValue.textContent = `$${profit.toFixed(2)}`;
      dashCalcResult.style.display = "block";
      dashCalcResult.textContent = `Estimated weekly profit at ${rate}%: $${profit.toFixed(2)}`;
    });
  }
</script>
